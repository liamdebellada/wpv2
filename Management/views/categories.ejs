<h1>Categories</h1>
<ul class="nav nav-tabs">
    <li class="nav-item dropdown">
      <a class="nav-link active" onclick="test(this)"  href="#" role="button" id="dropSelection" style="color: #2C3E50;">View</a>
    </li>
    <li>
        <a class="nav-link" onclick="test(this)" style="cursor:pointer" id="createSelection">Create new</a>
    </li>
</ul>

<div id="create" style="display: none; margin-top: 5px;">
  <div class="row">
    <div class="col-6">
      <div class="form-group">
        <label for="exampleFormControlInput1">Title</label>
        <input type="text" class="form-control" id="newTitle" placeholder="Enter Category key">
      </div>
    </div>
    <div class="col-6">
      <div class="form-group">
        <label for="exampleFormControlInput1">Category key</label>
        <input type="text" class="form-control" id="newCategoryKey" placeholder="Enter Category key">
      </div>
    </div>
  </div>
  
  <div class="form-group">
    <label for="exampleFormControlInput1">Image url</label>
    <input type="text" class="form-control" id="newImageUrl" placeholder="Enter image url" onkeyup="updateImagePreview(this)">
  </div>
  <label for="exampleFormControlInput1">Image preview</label>
  <div class="form-group" style="border: 1px solid grey;">
    <img id="previewImageCreate" style="width: 50px;">
  </div>
  <a href="#" class="btn btn-primary" onclick="createNewCategory()">Create Category</a>
</div>

<style>
    .editbannerbutton {
        padding-right: 2px;
        padding-left: 2px;
        padding-top: 0;
        padding-bottom: 0;
        border-radius: 0;
    }
</style>

<div id="dataTable" style="display: block;">
    <table class="table">
        <thead>
          <tr>
            <th scope="col">Category</th>
            <th scope="col">Icon</th>
            <th scope="col">Edit</th>
          </tr>
        </thead>
        <tbody>
        <% for (item in data) { %>
          <% for (i in data[item]) { %>
          <tr>
            <td><%=data[item][i].Title %></td>
            <td><image style="width: 20px;" src="<%= data[item][i].Image %>"></image></td>
            <td><button onclick="drawModal(this)" class="btn btn-dark editbannerbutton" id="<%= data[item][i]._id %>" data-items="<%=data[item][i].CategoryKey %>|<%= data[item][i].Image %>|<%= data[item][i]._id %>|<%= data[item][i].Title %>" style="margin: 0;" type="button" data-toggle="modal" data-target="#infoModal">Edit</button></td>
          </tr>
          <% } %>
        <% } %>
        </tbody>
      </table>
</div>

<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="border-radius: 0; border: none;">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Edit <text id="modalTitle"></text> Category</h5>
      </div>
      <div class="modal-body" style="display: block;">
        <div style="display: block;">
          <div class="row">
            <div class="col-6">
              <div class="form-group">
                <label for="formGroupExampleInput">Title</label>
                <input id="title" type="text" class="form-control" id="formGroupExampleInput" placeholder="Example input">
              </div>
            </div>
            <div class="col-6">
              <div class="form-group">
                <label for="formGroupExampleInput">Category Key</label>
                <input id="categoryKey" type="text" class="form-control" id="formGroupExampleInput" placeholder="Example input">
              </div>
            </div>
            
            
          </div>
          
          <div class="form-group">
            <label for="formGroupExampleInput2">Image url</label>
            <input onkeyup="updateImage(this)" id="icon" type="text" class="form-control" id="formGroupExampleInput2" placeholder="Another input">
          </div>
          <text>Image:</text> <img style="width: 15px" id="iconDisplay">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirmModal" data-dismiss="modal">Delete</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="updateCategory()">Save changes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="border-radius: 0; border: none;">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Deletion confirmation</h5>
      </div>
      <div class="modal-body" style="display: block;">
        <p>Are you sure you want to delete this category?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="deleteCategory()">Yes</button>
      </div>
    </div>
  </div>
</div>


<script>
      function test(option) {
        var dropdown = document.getElementById("dropSelection")
        var other = document.getElementById("createSelection")
        var creationPage = document.getElementById('create')
        var table = document.getElementById('dataTable')
        if (option.id == "createSelection") {
            option.classList.add('active')
            option.disabled = false;
            dropdown.disabled = true;
            dropdown.classList.remove('active')
            creationPage.style.display = "block"
            table.style.display = "none"
        } else {
            dropdown.disabled = false;
            other.classList.remove('active')
            other.disabled = true;
            dropdown.classList.add('active')
            table.style.display = "block"
            creationPage.style.display = "none"
        }
    }
    var dataArray = []

    function drawModal(item) {
      var modalTitle = document.getElementById("modalTitle")
      var title = document.getElementById("title")
      var categoryKey = document.getElementById("categoryKey")
      var icon = document.getElementById("iconDisplay")
      var iconUrl = document.getElementById("icon")

      var data = $("#" + item.id).data('items')
      var dataArr = data.split("|")
      dataArray = data.split("|")
      modalTitle.innerText = dataArr[3]
      title.value = dataArr[3]
      categoryKey.value = dataArr[0]
      iconUrl.value = dataArr[1]
      icon.src = dataArr[1]
    }

    function updateImage(item) {
      var icon = document.getElementById("iconDisplay")
      icon.src = item.value
    }

    function updateCategory(item) {
      $.ajax({
        type: "POST",
        url: "/updateCategory",
        data: {
            Title: document.getElementById("title").value,
            categoryKey: document.getElementById("categoryKey").value,
            Image: document.getElementById("icon").value,
            id: dataArray[2]
        }
      }).done(data => {
          window.location.href = data;
      });
    }


    function createNewCategory() {
      var categoryKey = document.getElementById("newCategoryKey").value
      var Image = document.getElementById("newImageUrl").value
      var Title = document.getElementById("newTitle").value

      $.ajax({
        type: "POST",
        url: "/createCategory",
        data: {
            Title: Title,
            categoryKey: categoryKey,
            Image: Image
        }
      }).done(data => {
          window.location.href = data;
      });
    }


    function deleteCategory() {
      $.ajax({
        type: "POST",
        url: "/deleteCategory",
        data: {
          id: dataArray[2]
        }
      }).done(data => {
          window.location.href = data;
      });
    }

    function updateImagePreview(data) {
      document.getElementById("previewImageCreate").src = data.value
    }
</script>